version: '3.8'

services:
  # Service 1: Laravel API (PHP-FPM)
  my_fiambond_api:
    build:
      context: ./my_fiambond_api
      dockerfile: Dockerfile # Assumes you have a Dockerfile in your Laravel directory
    container_name: fiambond-api
    working_dir: /var/www/html
    volumes:
      - ./my_fiambond_api:/var/www/html
    environment:
      # --- IMPORTANT ---
      # These variables configure your Laravel app to talk to LocalStack
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_BUCKET=my-local-bucket
      - AWS_ENDPOINT=http://localstack:4566
      - AWS_USE_PATH_STYLE_ENDPOINT=true
      # --- Laravel Environment ---
      - DB_CONNECTION=mysql
      - DB_HOST=mysql # Connects to the mysql service below
      - DB_PORT=3306
      - DB_DATABASE=fiambond
      - DB_USERNAME=user
      - DB_PASSWORD=password
    networks:
      - fiambond-network
    depends_on:
      - localstack
      - mysql

  # Service 2: React Frontend (Node Development Server)
  my_fiambond_react:
    build:
      context: ./my_fiambond_react
      dockerfile: Dockerfile # Assumes you have a Dockerfile in your React directory
    container_name: fiambond-react
    volumes:
      - ./my_fiambond_react:/app
      - /app/node_modules # Use the node_modules from within the container
    ports:
      - "3000:3000" # Expose React dev server port
    environment:
      - NODE_ENV=development
    networks:
      - fiambond-network

  # Service 3: Nginx Web Server (Reverse Proxy)
  nginx:
    image: nginx:alpine
    container_name: fiambond-nginx
    ports:
      - "80:80"
    volumes:
      - ./my_fiambond_api:/var/www/html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - my_fiambond_api
      - my_fiambond_react
    networks:
      - fiambond-network

  # Service 4: MySQL Database
  mysql:
    image: mysql:8.0
    container_name: fiambond-mysql
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_DATABASE: fiambond
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ROOT_PASSWORD: rootpassword
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - fiambond-network

  # Service 5: The LocalStack Container
  localstack:
    image: localstack/localstack:latest
    container_name: localstack-main
    ports:
      # Port for accessing LocalStack services from your host machine
      - "4566:4566"
      # Port for the LocalStack web dashboard (optional)
      - "8080:8080"
    environment:
      # Enables specific services. Add more as needed (e.g., SQS, LAMBDA)
      - SERVICES=s3
      - DEBUG=0
    volumes:
      # Persists LocalStack data between restarts
      - localstack-data:/var/lib/localstack
      # Mount a script to initialize AWS resources
      - ./init-aws.sh:/etc/localstack/init/ready.d/init-aws.sh
    networks:
      - fiambond-network

# Define the shared network
networks:
  fiambond-network:
    driver: bridge

# Define the persistent volumes
volumes:
  localstack-data:
  mysql-data: